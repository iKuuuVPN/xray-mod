name: Build and Release

on:
  workflow_dispatch:
  release:
    types: [published]
  push:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GOOS: linux
      GOARCH: amd64
      CGO_ENABLED: 1
    steps:
      - name: Checkout codebase
        uses: actions/checkout@v6

      - name: Show workflow information
        run: |
          _NAME=$(jq ".[\"$GOOS-$GOARCH\"].friendlyName" -r < .github/build/friendly-filenames.json)
          echo "GOOS: $GOOS, GOARCH: $GOARCH, RELEASE_NAME: $_NAME"
          echo "ASSET_NAME=$_NAME" >> $GITHUB_ENV

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          check-latest: true

      - name: Install Intel(R) IPSec Multi-Buffer
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends libipsec-mb-dev
          dpkg -l | grep -i ipsec-mb || true
          apt-cache policy libipsec-mb-dev libipsec-mb1 || true
          dpkg -L libipsec-mb-dev | head -n 200 || true
          dpkg -L libipsec-mb1 | head -n 200 || true
          ls -la /usr/lib /usr/lib/x86_64-linux-gnu /lib /lib/x86_64-linux-gnu 2>/dev/null | grep -i IPSec_MB || true

      - name: Get project dependencies
        run: go mod download

      - name: Build Xray
        run: |
          set -euxo pipefail
          mkdir -p build_assets
          COMMID=$(git describe --always --dirty)
          go build -tags ipsecmb -o build_assets/xray -trimpath -buildvcs=false -gcflags="all=-l=4" -ldflags="-X github.com/xtls/xray-core/core.build=${COMMID} -s -w -buildid= -linkmode=external -extldflags '-Wl,-rpath,\$ORIGIN'" -v ./main
          file ./build_assets/xray || true

      - name: Download GeoIP/GeoSite assets (no token)
        run: |
          set -euxo pipefail
          [ -d 'resources' ] || mkdir resources
          curl -fsSL --retry 5 --retry-delay 2 "https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/geoip.dat" -o ./resources/geoip.dat
          curl -fsSL --retry 5 --retry-delay 2 "https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/geosite.dat" -o ./resources/geosite.dat

      - name: Add additional assets into package
        run: |
          set -euxo pipefail
          mv -f resources/geo* build_assets/
          sudo ldconfig

          echo "ldconfig -p | grep -i IPSec_MB:"
          ldconfig -p | grep -i IPSec_MB || true

          LIB_SO1="$(ldconfig -p | awk '$1=="libIPSec_MB.so.1"{print $NF; exit}')"
          if [ -z "${LIB_SO1}" ]; then
            LIB_SO1="$(find /usr/lib /lib -name 'libIPSec_MB.so.1' -print -quit 2>/dev/null || true)"
          fi
          echo "Resolved LIB_SO1=${LIB_SO1}"
          if [ -z "${LIB_SO1}" ] || [ ! -f "${LIB_SO1}" ]; then
            echo "ERROR: libIPSec_MB.so.1 not found on runner"
            exit 1
          fi
          ls -la "${LIB_SO1}" || true
          file "${LIB_SO1}" || true
          cp -f "${LIB_SO1}" build_assets/

          # Optional symlink for convenience.
          (cd build_assets && ln -sf libIPSec_MB.so.1 libIPSec_MB.so)
          echo "build_assets after copying lib + geodata:"
          ls -la build_assets
          sha256sum build_assets/libIPSec_MB.so.1 || true

      - name: Verify runtime deps (ipsec-mb)
        run: |
          set -euxo pipefail
          readelf -d ./build_assets/xray | grep -E 'RPATH|RUNPATH'
          readelf -d ./build_assets/xray | grep -F '$ORIGIN'
          ldd ./build_assets/xray | grep -i IPSec_MB
          ldd ./build_assets/xray | grep -i "not found" && exit 1 || true

      - name: Copy README.md & LICENSE
        run: |
          set -euxo pipefail
          cp ${GITHUB_WORKSPACE}/README.md ./build_assets/README.md
          cp ${GITHUB_WORKSPACE}/LICENSE ./build_assets/LICENSE
          echo "Final build_assets:"
          ls -la build_assets

      - name: Create ZIP archive
        if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
        shell: bash
        run: |
          set -euxo pipefail
          pushd build_assets || exit 1
          touch -mt $(date +%Y01010000) *
          zip -9vr ../Xray-${{ env.ASSET_NAME }}.zip .
          popd || exit 1
          FILE=./Xray-${{ env.ASSET_NAME }}.zip
          echo "ZIP should contain libIPSec_MB.so.1:"
          zip -sf "$FILE" | grep -Fi 'libIPSec_MB.so.1'
          DGST=$FILE.dgst
          for METHOD in {"md5","sha1","sha256","sha512"}
          do
            openssl dgst -$METHOD $FILE | sed 's/([^)]*)//g' >>$DGST
          done

      - name: Upload files to Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: Xray-${{ env.ASSET_NAME }}
          path: |
            ./Xray-${{ env.ASSET_NAME }}.zip*
            ./build_assets/*
